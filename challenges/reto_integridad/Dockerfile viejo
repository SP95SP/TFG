FROM ubuntu:22.04

# Evita preguntas de tzdata y locales
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    openssh-server \
    sudo \
    passwd \
    python3 \
    python3-pip \
    vim \
    && rm -rf /var/lib/apt/lists/*

# Crea los usuarios y asigna contraseñas inseguras
RUN useradd -m -s /bin/bash manolo && echo 'manolo:manolo' | chpasswd
RUN useradd -m -s /bin/bash maria && echo 'maria:maria' | chpasswd
RUN useradd -m -s /bin/bash carlos && echo 'carlos:carlos' | chpasswd
RUN useradd -m -s /bin/bash paco && echo 'paco:paco' | chpasswd

# Crea usuario admin con home /root y shell bash, prohíbe acceso SSH directo
RUN useradd -m -d /root -s /bin/bash admin && echo 'admin:password123' | chpasswd

# Prohibir acceso SSH a admin (AllowUsers en sshd_config)
RUN echo "AllowUsers manolo maria carlos paco" >> /etc/ssh/sshd_config

# Copia archivos de reto
COPY flag.txt /tmp/flag.txt
COPY users.hashes /tmp/users.hashes
COPY watcher.sh /watcher.sh
COPY entrypoint.sh /entrypoint.sh

# Flag en root (admin)
RUN mv /tmp/flag.txt /root/flag.txt && chmod 600 /root/flag.txt && chown admin:admin /root/flag.txt

# Prepara los hashes en el home de manolo
RUN mkdir -p /home/manolo/secretos && \
    cp /tmp/users.hashes /home/manolo/secretos/hashes.txt && \
    chown -R manolo:manolo /home/manolo/secretos

# Configura el log vacío
RUN touch /var/log/access.log && chmod 666 /var/log/access.log

# SSH service
RUN mkdir /var/run/sshd

# Entrypoint para arrancar el watcher + sshd
RUN chmod +x /entrypoint.sh /watcher.sh
ENTRYPOINT ["/entrypoint.sh"]

EXPOSE 22
